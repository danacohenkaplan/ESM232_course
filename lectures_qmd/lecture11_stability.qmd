---
title: "Exploring Stability in Dynamic Systems"
format: revealjs
execute: 
  echo: TRUE
theme: solarized
resources: ["img/"]
css: ["slides.css"]
editor: visual
---

```{r setup, include=FALSE}
library(tidyverse)
library(deSolve)
library(here)
library(sensitivity)
library(ggpubr)
```

## Fixed Harvest {.scrollable}

What if you wanted to take the same amount of carbon each year - what would the model look like?

Think about what you would need to do to make this realistic

## Fixed Harvest Example {.scrollable}

```{r fixed}
source(here("R/dharvestfixed.R"))

dharvestfixed
```

## Run the forest model {.scrollable}

-   harvest of 2kgC per year (fixed rate)
-   carrying capacity of 1000kg
-   growth rate of 0.05
-   minimum carbon before harvest is allowed 20kg

## Run for 100 years {.scrollable}

try it

what happens?

```{r try100}
tm <- seq(from = 1, to = 100)
Cinitial <- 30
gps <- list(harv = 2, K = 1000, r = 0.05, mincarbon = 20)

res <- ode(Cinitial, tm, dharvestfixed, gps)

colnames(res) <- c("time", "carbon")
head(res)
tail(res)
```

## Numerical Integration Issues {.scrollable}

-   particularly happens if model is "stiff" (when system state reaches a threshold, behavior changes alot)

-   our minimum carbon is a threshold

When that happens try another integration method See *ode* help for some options

## example {.scrollable}

```{r try2}
# notice how it fails after a certain length of time
# try another method
res <- ode(Cinitial, tm, dharvestfixed, gps, method = "euler")
colnames(res) <- c("time", "carbon")
head(res)
tail(res)

ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "Fixed Harvest of 2kg/year\n Starting conditions 30kgC")


ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_line() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "Fixed Harvest of 2kg/year\n Starting conditions 30kgC")

# why this pattern
```

## Stability {.scrollable}

Stability analysis investigates how the system state changes, particularly focusing on where the system state 'ends up' over time and what happens when there are small perturbations to the system state

Other examples?

How would you define it?

## A broader measure of stability {.scrollable}

-   persistence

-   cycling doesn't necessarily mean unstable in an ecological sense

-   define stability based on whether or not structure or function stays within expected ranges after a "press" or "pulse" disturbance

-   can define metrics, similar to what we did for estimating performance or sensitivity

-   multiple metrics can be useful

## Examples? {.scrollable}

Ecological systems?

Human systems?

EJ?

## What harvest rate leads to an unstable forest? {.scrollable}

using proportional harvest, what rate leads to a stable forest

```{r stableforest}
source(here("R/dharvest.R"))
dharvest

# set the time steps you want to see
tm <- seq(from = 1, to = 100)

# inital conditions
Cinitial <- 30

# set the parameters
gps <- list(harv = 0.1, K = 1000, r = 0.05, mincarbon = 20)

# run the model
res <- ode(Cinitial, tm, dharvest, gps, method = "euler")
colnames(res) <- c("time", "carbon")
```

# Graph the results

```{r}
# look at the results
ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "Proportional Harvest of 10% per year \n Starting conditions 30kgC")

# is it stable
# what can you change to make it stable
```

## Ways to use dynamic models {.scrollable}

*Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change..*

-   sensitivity analysis of output
    -   output generated by solving differential equation to see system evolution in time or space
    -   output response to variation in inputs/parameters
    -   quantifying how summary measures respond to variation in inputs/parameters

Stability focus..

-   how does systems state evolution vary with inputs/parameters
-   OR where does the system end up over time

## Model versus the real world {.scrollable}

Models can help to develop understanding, theory and hypothesis about stability by showing how different assumptions (conceptual models) impact stability

The **WHY** of stability

But the real world is more complex - but we can learn by understanding simpler models

## Stability analysis for simple differential equations {.scrollable}

A mathematical approach..

We can look at how the derivative (rate of change) \* under different system states to get a picture of when our system will be stable \* (e.g where small perturbations just bring the system back to a relatively constant state)

One way we can do this WITHOUT solving the differential equation is to look at the derivatives at different values (system states)

-   When the derivative is 0 the system is stable

-   Positive derivatives are growth

-   Negative are decline

We can use derivatives to see whether and when stability will happen

## Harvest as an example {.scrollable}

graph the derivative (how the forest carbon is changing) for different forest carbons (stock/state)

Notice where derivatives are

-   0

-   positive (growing)

-   negative (declining)

Recall these are all for a proportional harvest rate of 4% per year and a growth rate of 0.05, etc

```{r simpleapp}
tm <- seq(from = 1, to = 100)
gps <- list(harv = 0.04, K = 1000, r = 0.05)

# create a vector of current values of carbon
Ccurr <- data.frame(Ccurr = seq(from = 1, to = 300, by = 5))
Ccurr$derv <- unlist(Ccurr$Ccurr %>% map(~ dharvest(parms = gps, Time = NULL, biomass = .x)))
```

## Plot the derivative for difference "starting points" (forest carbon

)

```{r simpleapp2}
ggplot(Ccurr, aes(Ccurr, derv)) +
  geom_point() +
  geom_hline(yintercept = 0, col = "red") +
  labs(y = "Derivative\n (Rate of change of forest carbon) \n(kg/C/year)", x = "Current Forest Carbon Stock (kgC)")
```

## what do you learn from this? {.scrollable}

-   Is there a way to get a stable forest, given our harvest rate and growth rate?

-   what size of forest would you need to *start* from

-   try it

```{r try3}
# rerun our model with new initial condition that we take from the plot
tm <- seq(from = 1, to = 100)
gps <- list(harv = 0.04, K = 1000, r = 0.05)

Cinitial <- 300
res <- ode(Cinitial, tm, dharvest, gps)
colnames(res) <- c("time", "carbon")

# look at the results
ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "Proportional Harvest of 4%year\n Starting conditions 300kgC")
```

## Using derivatives to algerbraically find stability {.scrollable}

We can more formally find stability by finding the system state when the derivative is zero

$$  \frac{\partial C}{\partial t} = r*biomass*(1-\frac{biomass}{K})-harv*biomass$$

$$  0 = r*biomass*(1-\frac{biomass}{K})-harv*biomass $$

$$   biomass = K*\frac{r-h}{r} $$

$$ biomass = 1000 * (0.05-0.04)/0.05 = 200 $$

try it

## Parameter and Initial Conditions Interactions {.scrollable}

Stability also reflects other parameters -such as harvest rate

we can also experiment with how stable harvest might change with harvest rate

try repeating above with lower and higher harvest rates

```{r stability2}
source(here("R/dharvest.R"))
dharvest

# given some forest characteristics - lets look at derivatives under different harvest rates
lowHrate <- 0.015
gps <- list(harv = lowHrate, K = 100, r = 0.05)

# look at the derivative over a range of forest sizes

findstable <- data.frame(Ccurr = seq(from = 1, to = 100, by = 5))
# notice use of Time=NULL, and map to compute derivative
# for different values of forest biomass
findstable$dervHlow <- unlist(findstable$Ccurr %>% map(~ dharvest(parms = gps, Time = NULL, biomass = .x)))

ggplot(findstable, aes(Ccurr, dervHlow)) +
  geom_point() +
  geom_hline(yintercept = 0, col = "red") +
  labs(y = "Derivative\n (Rate of change of forest carbon) (kg/C/year)", x = "Current Forest Carbon Stock (kgC)")

# look at a different harvest rate
midHrate <- 0.02
gps <- list(harv = midHrate, K = 100, r = 0.05)
findstable$dervHmid <- unlist(findstable$Ccurr %>% map(~ dharvest(parms = gps, Time = NULL, biomass = .x)))

# try high rate
highHrate <- 0.05
gps <- list(harv = highHrate, K = 100, r = 0.05)
findstable$dervHhigh <- unlist(findstable$Ccurr %>% map(~ dharvest(parms = gps, Time = NULL, biomass = .x)))


# plot them all together
tmp <- gather(findstable, key = "HarvestRate", value = "value", -Ccurr)
ggplot(tmp, aes(Ccurr, value, color = HarvestRate)) +
  geom_point() +
  geom_hline(yintercept = 0, col = "black") +
  labs(x = "Forest Biomass (kgC)", y = "Forest Growth Rate (kgC/year)")

# notice how with higher harvest rates the stable population will be lower
```

## Stability in changing systems - just looking at dervatives {.scrollable}

Knowing the stability can help you understand the dynamics of the system

If we start with a Forest Carbon of 50 and low harvest rate what will happen

If we start with a Forest Carbon of 50 and a high harvest rate what will happen

Try it to find out if you are right

```{r  check}
tm <- seq(from = 1, to = 500)
gps <- list(harv = lowHrate, K = 100, r = 0.05)
Pinitial <- 50
res <- ode(Pinitial, tm, dharvest, gps)
colnames(res) <- c("time", "carbon")
ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "low harvest rate")




gps <- list(harv = highHrate, K = 100, r = 0.05)
Pinitial <- 50
res <- ode(Pinitial, tm, dharvest, gps)
colnames(res) <- c("time", "carbon")
ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "High Harvest Rate")
```

## For next class

-   Burke et al., 2021

-   Graup et al., 2022

-   Pick on of the papers to focus on in more detail, for this paper do the following:

-   In 2-3 sentences, describe how parameter uncertainty was used in the paper

-   Ask one question - something you'd like to know that wasn't covered or wasn't clear in the paper

-   If you had the same model set up available to you, what additional scenario could you run? why?

-   Upload to Canvas before class - and we will finalize in class

## Extra Credit Assignment {.scrollable}

1.  Add a harvesting to your forest growth model from the previous assignment You can be as simple or complex as you want (e.g you could repeat what I did above by making harvesting proportional to biomass)

2.  Perform some sensitivity analysis to assess how harvesting parameters interact with forest growth parameters to influence forest carbon at the end of the simulation time period (you can choose how long this is)

3.  Write 2-3 sentences to comment on what you might learn from your sensitivity analysis
