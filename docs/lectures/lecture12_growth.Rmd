---
title: "Modeling Growth and Disturbance with Dynamic Models"
output:
  slidy_presentation:
    highlight: pygments
  html_document: default
  pdf_document: default
  ioslides_presentation:
    highlight: pygments
  beamer_presentation:
    highlight: pygments
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sensitivity)
library(tidyverse)
library(deSolve)
```
# Example with our population ODE

To have growth slow as carrying capcity is reached we can 
implement a logistic growth model


```{r sen, error=TRUE}
source("../R/dexppopK.R")

dexppopK




# want to learn about sensitivity to growth rate (r) and carrying capacity 
# set the number of parameters
np=100
K = rnorm(mean=300, sd=50, n=np)
r = rnorm(mean=0.01, sd=0.005, n=np)
X1 = cbind.data.frame(r=r, K=K)

# repeat to get our second set of samples
K = rnorm(mean=300, sd=50, n=np)
r = rnorm(mean=0.01, sd=0.005, n=np)
X2 = cbind.data.frame(r=r, K=K)

sens_P = sobolSalt(model = NULL,X1, X2, nboot = 300)

# our parameter sets are
head(sens_P$X)

# lets add names 
colnames(sens_P$X) = c("r","K")

# I may re-use this function so I saved it as a file 
# maxyear doesn't make sense for a growth that slows gradually - so I'll use year when population doubles
source("../R/compute_pop_metrics.R")

Pinitial = 100

# I continually update the wrapper to I'll keep in inline
# you could make it a separate file as well 
simtimes=seq(from=1, to=500, by=5)

p_wrapper = function(r,K, Pinitial, simtimes, func, metrics_func) {
    parms = list(r=r, K=K)
    result = ode(y=Pinitial, times=simtimes, func=func, parms=parms) 
    colnames(result)=c("time","P")
  # get metrics
    metrics=as.data.frame(result) %>% metrics_func()
  return(metrics)
}

allresults = as.data.frame(sens_P$X) %>% pmap(p_wrapper, Pinitial=Pinitial, simtimes=simtimes, func=dexppopK, metrics_func=compute_pop_metrics)

# extract out results from pmap into a data frame
allres = allresults %>% map_dfr(`[`,c("maxpop","dyear"))


# create boxplots
tmp = allres %>% gather(key="metric", value="value")
ggplot(tmp, aes(metric, value, col=metric))+geom_boxplot()

# compute sobol indicies (separately for the two different outputs)
sens_P_maxpop = sensitivity::tell(sens_P,allres$maxpop)

# first-order indices (main effect without co-variance)
sens_P_maxpop$S

# total sensitivity index -note that this partitions the output variance - so values sum to 1
sens_P_maxpop$T



# create another one for max year
sens_P_dyear = sensitivity::tell(sens_P,allres$dyear)
# first-order indices (main effect without co-variance)

#notice that this fails because of NAs - scenarios where population does not double
summary(allres$dyear)

# clean up option - not ideal but will work - set double year to max simtimes
allres$dyear_clean = ifelse(is.na(allres$dyear), max(simtimes), allres$dyear)
sens_P_dyear = sensitivity::tell(sens_P,allres$dyear_clean)
sens_P_dyear$S

# total sensitivity index -note that this partitions the output variance - so values sum to 1
sens_P_dyear$T
```
# Ways to use dynamic models 

Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change

* sensitivity analysis of output (output generated by solving differential equation to see system evolution in time or space)
  * output response to variation in inputs/parameters
  * quantifying how summary measures respond to variation in inputs/parameters
* examine derivative at different values (simpler, not solving required but just tells you how system will change given a particular state)
  * how does stability vary with inputs/parameters

# Another Application

Modeling carbon growth in a forest

r is growth rate
K is maximum carbon capacity of the forest

We can actually re-use our model - if we assume forest growth follows a logistic growth curve

```{r forest}
source("../R/dexppopK.R")

dexppopK
# set parameters
forestparms = list(K=100,r=0.2)

# create a time sequence
tm = seq(from=1,to=100)

# start a small forest
postfire_initial_carbon = 2

# watch it grow
forest = ode(y=postfire_initial_carbon, times=tm, dexppopK, parms=forestparms)

colnames(forest)=c("time","carbon")
ggplot(as.data.frame(forest),aes(time, carbon) )+geom_line()


```



# Disturbance

What would our model look like if we harvest the forest on a regular basis

2 options

* a fixed harvest every year

* proportional harvest (% of current stock)

Lets start with an annual proportional harvest

(note we could make this really simple and just reduce the growth rate - but sometimes
helpful to have both parameters as "options")

```{r harvest}

# fixed amount per year
source("../R/dharvest.R")
dharvest

# try it out
tm = seq(from=1, to=500)
Pinitial = 1
gps = list(harv=0.18, K=100, r=0.2)
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()

# what if we harvest a a much greater rates

# lets vary the harvest rates from 0.0 to 0.4
harvestr = seq(from=0.0, to=0.4, by=0.025)

# save all of the trajectories


# use a wrapper function to just return the carbon trajectories
getcarbon = function(Pinitial, tm, harv, K, r, hfunc) {
  gps = list(harv=harv, K=K, r=r)
  res = ode(Pinitial,tm, hfunc, gps)
  colnames(res)=c("time","carbon")
  res=as.data.frame(res)
  return(carbon=res$carbon)
}

# apply this function to all harvest values
res = harvestr %>% map_dfc(~getcarbon( Pinitial=Pinitial, tm=tm, K=100, r=0.2, hfun=dharvest, harv=.x))
# rows are time, columns are carbon for each harvest scenario
colnames(res)=harvestr
res=as.data.frame(res)
res$time=tm
# put in to a form where we can plot
resl = gather(res, key="harvestr",value="carbon", -time)
ggplot(resl,aes(time, carbon, col=harvestr))+geom_line()


# notice that stable forest value changes with harvest rates

# notes that some forests are not stable - (or stablity is zero)

# see this at the beginning - plot the first 10 years
ggplot(subset(resl, time < 10),aes(time, carbon, col=harvestr))+geom_line()

```

Try different harvest rates...notice how carbon growth changes...what does stability mean - can you find parameter sets that lead to a stable non-zero forest

We could do some sensitivity analysis to see how harvest rate, and growth rate interact to control where the forest ends up after 10 years and 50 years (short and long planning horizons)

We will use our compute metrics and wrapper to make this easy

```{r harvestsend}

# fixed amount per year
source("../R/dharvest.R")


# lets assume a uniform distribution of harvest rates
# and of normal growth rates
np=200

r = rnorm(mean=0.3, sd=0.05, n=np)
harv = runif(min=0.0, max=0.4, n=np)
K = 
X1 = cbind.data.frame(r=r, harv=harv)

# repeat to get our second set of samples
r = rnorm(mean=0.3, sd=0.05, n=np)
harv = runif(min=0.0, max=0.4, n=np)
X2 = cbind.data.frame(r=r, harv=harv)

# create our sobel object and get sets ofparameters for running the model

sens_forest = sobolSalt(model = NULL,X1, X2, nboot = 300)
colnames(sens_forest$X)= c("r","harv")
# do a quick test
# try it out
tm = seq(from=1, to=50)
Pinitial = 1
parms = list(r=sens_forest$X[1,1], harv=sens_forest$X[1,2], K=100)
res = ode(y=Pinitial,times=tm, func=dharvest, parms=parms)
res=as.data.frame(res)
colnames(res)=c("time","C")

# compute our two metrics of interest - harvest after 10 and 50 years
compute_metrics = function(res) {
 C50 = res[50]
 C10 = res[10]
return(list(C50=C50, C10=C10))}

# use a wrapper function to just return the carbon trajectories
p_wrapper = function(r,harv, K, Pinitial, simtimes, func) {
    parms = list(r=r, K=K, harv=harv)
    result = ode(y=Pinitial, times=simtimes, func=func, parms=parms) 
    result=as.data.frame(result)
   colnames(result)=c("time","C")
  # get metrics
  metrics=compute_metrics(result$C)
  return(metrics)
}

# notice how we added in K, a parameter that we are NOT varying

# try it out
tm = seq(from=1, to=50)
Pinitial = 1


allresults = as.data.frame(sens_forest$X) %>% pmap(p_wrapper, K=100, Pinitial=Pinitial, simtimes=tm, func=dharvest)

# extract out results from pmap into a data frame
allres = allresults %>% map_dfr(`[`,c("C10","C50"))

tmp = allres %>% gather(key="metric", value="value")
ggplot(tmp, aes(metric, value, col=metric))+geom_boxplot()

# link with parameters to see how parameters together
# impact something we care aboue C50

allresp = cbind.data.frame(sens_forest$X, allres)
ggplot(allresp, aes(harv, C50, col=r))+geom_point()

# notice how we can see the impact of harvesting - and how growth rates reduce the sustainable harvest
```

# Assignment

Consider the following model of forest growth (where forest size in measured in units of carbon (C))

$dC/dt  = r*C$  for forests where C is below a threshold canopy closure

$dC/dt = g*(1- C/K)$ for forests where carbon is  at or above the threshold canopy closure

and $K$ is a carrying capacity in units of carbon

The size of the forest ($C$), Canopy closure threshold and carrying capacity are all in units of carbon 

You could think of the canopy closure threshold as the size of the forest at which growth rates change from exponential to linear

You can think of $r$, as early exponential growth rate and $g$ as the linear growth rate once canopy closure has been reached

Here's what you will do

1. Implement this model in R (as a differential equation) (**Grading 25% - we will look for correct implementation but also good programming style - meaningful variable names, comments/documentation throughout ** )

2. Run the model for 300 years (using the ODE solver)  starting with an initial forest size of 10 kg/C, and using the following parameters

canopy closure threshold of 50 kgC 

 $K$ = 250 kg C (carrying capacity) 

 $r$=  0.01 (exponential growth rate before before canopy closure)

 $g$ = 2 kg/year (linear growth rate after canopy closure)

Graph the results. (**15% - we look for an appropriate graphs and good visualization practice - labels, etc**)

3. Run a sobol sensitivity analysis that explores how the 1) estimated maximum forest size (e.g maximum of $C$  300 years, and 2)  forest size after a 100 years) varies with the pre canopy closure growth rate ($r$) and post-canopy closure growth rate ($g$) and canopy closure threshold and carrying capacity($K$)

Assume that parameters are all normally distributed with means as given above and standard deviation of 10% of mean value

4. Graph the results of the sensitivity analysis as a box plot of maximum forest size and record the two Sobol indices (S and T). (**25% - correct implementation of Sobol and good graphing style -label etc **)

In 2-3 sentences, discuss what the results of your simulation might mean for climate change impacts on forest growth (e.g think about what parameters climate change might influence ). (**25% - wee look for reasonable discussion that uses the results from your analysis and give extra points for discussions that offer particularly creative or insightful commentary**)

Submit R markdown with model implementation, graphs and sensitivity analysis and R file with your model

(**Final 10% for well organized clear R markdown**)

Work in Groups - Due Thursday May 19th
